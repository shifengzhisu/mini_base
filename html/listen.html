<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å®šå­¦éœ¸å¬å†™ 11.0 | æœ€ç»ˆå®Œæ•´ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@900&family=Zcool+KuaiLe&display=swap" rel="stylesheet">
    <!-- OCR åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        :root {
            --k-bg: #E1F5FE;
            --menu-blue: #29B6F6; --menu-border: #01579B; --menu-highlight: #FFEE58;
            --k-main: #4FC3F7; --k-main-dark: #0288D1;
            --k-accent: #FFD54F; --k-success: #66BB6A; --k-error: #EF5350;
            --k-text: #37474F;
        }

        body {
            background-color: var(--k-bg);
            background-image: radial-gradient(white 20%, transparent 20%);
            background-size: 30px 30px;
            font-family: 'Nunito', 'Zcool KuaiLe', sans-serif;
            color: var(--k-text);
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .app-container { width: 98%; max-width: 1400px; height: 95vh; position: relative; }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        .scene { display: none; width: 100%; height: 100%; }
        .scene.active { display: block; animation: fadeUp 0.3s ease; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* --- å¸ƒå±€ Grid --- */
        .layout-grid {
            display: grid; grid-template-columns: 260px 1fr 1.2fr; gap: 20px; height: 100%;
            padding: 10px; box-sizing: border-box;
        }

        /* --- å·¦ä¾§èœå• --- */
        .col-menu { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .menu-title { font-size: 1.4rem; color: var(--k-main-dark); text-align: center; margin-bottom: 15px; transform: rotate(-2deg); flex-shrink: 0; }
        .menu-scroll-area { flex: 1; overflow-y: auto; padding: 10px 5px; scrollbar-width: none; -ms-overflow-style: none; }
        .menu-scroll-area::-webkit-scrollbar { display: none; }
        
        .k-btn-menu {
            position: relative; width: 200px; height: 55px; margin-bottom: 15px;
            background: var(--menu-blue); border: 3px solid white; border-radius: 12px;
            box-shadow: 4px 4px 0 var(--menu-border); cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .k-btn-menu:hover { filter: brightness(1.1); transform: scale(1.02) !important; }
        .k-btn-menu.active { background: var(--menu-highlight); box-shadow: 4px 4px 0 #F57F17; z-index: 10; }
        .k-btn-text { color: white; font-weight: 900; pointer-events: none; max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .k-btn-menu.active .k-btn-text { color: #5D4037; }
        .k-btn-del {
            position: absolute; right: -8px; top: -8px; width: 22px; height: 22px;
            background: var(--k-error); border: 2px solid white; border-radius: 50%; color: white;
            display: flex; align-items: center; justify-content: center; opacity: 0; cursor: pointer;
        }
        .k-btn-menu:hover .k-btn-del { opacity: 1; }
        .btn-save-list { background: #7E57C2; color: white; width: 100%; margin-top: 10px; flex-shrink: 0; }

        /* --- ä¸­é—´é¢„è§ˆ --- */
        .col-preview {
            background: #FFF9C4; border: 4px solid white; border-radius: 20px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1); padding: 15px; 
            display: flex; flex-direction: column; transform: rotate(1deg); overflow: hidden;
        }
        .preview-header { text-align: center; padding-bottom: 10px; border-bottom: 2px dashed #BDBDBD; color: #F9A825; font-weight: bold; flex-shrink: 0; }
        .preview-list { flex: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; }
        .preview-item {
            background: rgba(255,255,255,0.6); padding: 8px; margin-bottom: 6px; border-radius: 8px;
            font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;
        }
        .tag-trans { background: #E1F5FE; color: #0277BD; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; }

        /* --- å³ä¾§æ“ä½œ --- */
        .col-control {
            background: white; border: 4px solid white; border-radius: 20px;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1); padding: 20px; 
            display: flex; flex-direction: column; gap: 12px; transform: rotate(-1deg); overflow: hidden;
        }
        .mode-switcher, .tool-row, .btn-group-grid, .hint-txt, .ai-toggle-row { flex-shrink: 0; }
        
        .mode-switcher { display: flex; background: #ECEFF1; padding: 4px; border-radius: 50px; }
        .mode-btn { flex: 1; border: none; background: transparent; padding: 8px; border-radius: 40px; font-weight: bold; color: #90A4AE; cursor: pointer; }
        .mode-btn.active { background: white; color: var(--k-main-dark); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tool-row { display: flex; align-items: center; justify-content: space-between; background: #E1F5FE; padding: 8px 12px; border-radius: 12px; }
        
        textarea {
            flex: 1; width: 100%; border: 3px solid #CFD8DC; border-radius: 15px;
            padding: 12px; font-family: inherit; resize: none; outline: none; box-sizing: border-box; font-size: 1rem;
            overflow-y: auto; min-height: 100px;
        }
        textarea:focus { border-color: var(--k-main); }

        .btn-group-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: auto; }
        .btn {
            border: 3px solid white; border-radius: 50px; padding: 10px 20px; font-weight: 800; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15); transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 6px; font-family: inherit;
        }
        .btn:active { transform: scale(0.95); box-shadow: none; }
        .btn-primary { background: var(--k-main); color: white; font-size: 1.2rem; }
        .btn-trans { background: #AB47BC; color: white; }
        .btn-scan { background: var(--k-accent); color: #5D4037; font-size: 0.9rem; padding: 6px 12px; }

        /* AI å¼€å…³ */
        .ai-toggle-row {
            display: flex; align-items: center; justify-content: space-between;
            background: #F3E5F5; padding: 8px 12px; border-radius: 12px; color: #8E24AA; font-weight: bold;
        }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #CCC; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #8E24AA; }
        input:checked + .slider:before { transform: translateX(24px); }

        /* --- æ¸¸æˆç•Œé¢ --- */
        .play-container {
            width: 100%; max-width: 650px; margin: 0 auto;
            background: white; border-radius: 30px; padding: 25px; height: 90%;
            display: flex; flex-direction: column; position: relative;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1); 
            overflow: visible !important; /* å…è®¸æ‰‡å½¢é£å‡º */
            z-index: 1;
        }
        .timer-bar-wrap { height: 18px; background: #ECEFF1; border-radius: 10px; border: 2px solid white; overflow: hidden; margin: 15px 0; }
        .timer-fill { height: 100%; background: var(--k-main); width: 100%; }
        
        .answer-box {
            background: #E0F7FA; flex: 1; border-radius: 20px; display: flex;
            align-items: center; justify-content: center; 
            font-size: 5rem; /* å¤§å­—ä½“ */
            font-weight: 800; color: #006064; margin: 20px 0;
            transition: all 0.3s;
        }
        .play-container.dimmed .answer-box, .play-container.dimmed .timer-bar-wrap, .play-container.dimmed #play-controls {
            opacity: 0.1; filter: blur(2px); pointer-events: none;
        }

        /* --- æ‰‘å…‹æ‰‡å½¢ç»“æœå±‚ --- */
        .result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: none; justify-content: center; align-items: center; z-index: 100;
        }
        .result-overlay.active { display: flex; pointer-events: auto; }

        .fan-card {
            position: absolute; left: 0; right: 0; margin: 0 auto; top: 15%;
            width: 300px; height: 60%; background: white; border-radius: 20px; border: 4px solid white;
            padding: 15px; box-shadow: 0 15px 30px rgba(0,0,0,0.25); display: flex; flex-direction: column;
            opacity: 0; transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); transform-origin: center bottom;
        }
        .fan-card h4 { margin: 5px 0 10px 0; text-align: center; font-size: 1.2rem; }
        .fan-card .list-wrap { flex: 1; overflow-y: auto; background: #FAFAFA; border-radius: 10px; padding: 5px; font-size: 0.9rem;}
        
        .fan-card.correct.active { opacity: 1; transform: translateX(-180px) rotate(-15deg); background: #E8F5E9; border-color: var(--k-success); z-index: 102; }
        .fan-card.wrong.active { opacity: 1; transform: translateX(180px) rotate(15deg); background: #FFEBEE; border-color: var(--k-error); z-index: 101; }
        
        /* å¤§åˆ†æ•°çƒ */
        .score-badge {
            position: absolute; z-index: 103; top: -30px;
            width: 160px; height: 160px; /* å¢å¤§ */
            background: var(--k-accent);
            border: 5px solid white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transform: scale(0); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.3s;
        }
        .score-badge.active { transform: scale(1) translateY(-40px); }
        #score-val { color: white; font-size: 4.5rem; font-weight: 900; line-height: 1; }
        
        .result-actions {
            position: absolute; bottom: -60px; width: 100%; display: flex; justify-content: center; gap: 15px; 
            opacity: 0; transition: 0.5s 0.8s; z-index: 105;
        }
        .result-overlay.active .result-actions { opacity: 1; bottom: 30px; }

        /* --- ğŸ”® AI é­”æ³•çœ¼ (æ—‹è½¬è™šçº¿ç‰ˆ) --- */
        .magic-camera-widget {
            position: fixed; bottom: 30px; right: 30px; width: 160px; height: 160px;
            border-radius: 50%; border: 5px solid white; background: #222;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 2000; display: none;
            transition: transform 0.3s;
        }
        .magic-camera-widget.active { display: block; }
        .magic-video { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); border-radius: 50%; position: relative; z-index: 1;
        }
        /* æ—‹è½¬è¾¹æ¡†ä¼ªå…ƒç´  */
        .magic-camera-widget::after {
            content: ""; position: absolute; top: -5px; left: -5px; right: -5px; bottom: -5px;
            border-radius: 50%; z-index: 2; pointer-events: none; border: 5px solid transparent; transition: border-color 0.3s;
        }
        /* çŠ¶æ€: ä½å¤´å†™å­— (è“è‰²è™šçº¿æ…¢è½¬) */
        .magic-camera-widget.status-writing::after { border: 5px dashed var(--k-main); animation: spinRing 10s linear infinite; }
        /* çŠ¶æ€: æŠ¬å¤´çœ‹å± (ç»¿è‰²å®çº¿å¿«è½¬) */
        .magic-camera-widget.status-looking::after { border: 5px solid var(--k-success); border-top-color: transparent; border-right-color: transparent; animation: spinRing 1s linear infinite; }
        /* çŠ¶æ€: æ‰‹åŠ¿æ ¸å¯¹ (ç´«è‰²å‘¼å¸) */
        .magic-camera-widget.status-checking::after { border: 5px solid #AB47BC; animation: pulseRing 2s infinite; }

        @keyframes spinRing { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulseRing { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

        .magic-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            font-size: 5rem; z-index: 10; text-shadow: 0 5px 10px rgba(0,0,0,0.5);
            opacity: 0; transition: 0.2s;
        }
        .magic-overlay.show { opacity: 1; transform: scale(1.2); }

        .mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }

        /* æ‰‹æœºé€‚é… */
        @media (max-width: 900px) {
            body { overflow: auto; align-items: flex-start; }
            .layout-grid { display: block; height: auto; padding-bottom: 50px; }
            .col-menu { height: auto; margin-bottom: 20px; overflow: visible; }
            .menu-scroll-area { display: flex; overflow-x: auto; padding: 10px; height: 80px; }
            .k-btn-menu { flex-shrink: 0; margin-right: 15px; }
            .col-preview { height: 250px; margin-bottom: 20px; }
            .col-control { height: auto; margin-bottom: 20px; }
            .play-container { height: 600px; overflow: hidden !important; } 
            .fan-card { width: 70%; height: 50%; }
            .fan-card.correct.active { transform: translateX(-40px) rotate(-5deg); left: 0; }
            .fan-card.wrong.active { transform: translateX(40px) rotate(5deg); right: 0; margin-left: auto;}
            .magic-camera-widget { width: 100px; height: 100px; bottom: 10px; right: 10px; }
            .magic-overlay { font-size: 3rem; }
        }
    </style>
</head>
<body>

    <div id="mask" class="mask">
        <div style="font-size:3rem; animation:spin 1s infinite linear">ğŸŒ€</div>
        <h3 id="mask-txt" style="color:#0277BD">Loading...</h3>
    </div>

    <!-- AI é­”æ³•çœ¼ -->
    <div id="magic-widget" class="magic-camera-widget">
        <video id="webcam" class="magic-video" autoplay playsinline></video>
        <div id="magic-overlay" class="magic-overlay"></div>
    </div>

    <div class="app-container">
        <!-- åœºæ™¯1: å‡†å¤‡ -->
        <div id="scene-setup" class="scene active">
            <div class="layout-grid">
                <!-- å·¦èœå• -->
                <div class="col-menu">
                    <div class="menu-title">ğŸ“š å•è¯ä¹¦æ¶ (<span id="book-count">0</span>/7)</div>
                    <div class="menu-scroll-area" id="menu-area"></div>
                    <button class="btn btn-save-list" onclick="saveCurrentToList()">ğŸ’¾ ä¿å­˜æ–°ä¹¦</button>
                </div>

                <!-- ä¸­é¢„è§ˆ -->
                <div class="col-preview">
                    <div class="preview-header">ğŸ“ é¢„è§ˆ (<span id="count">0</span>)</div>
                    <div id="preview-list" class="preview-list"></div>
                </div>

                <!-- å³æ“ä½œ -->
                <div class="col-control">
                    <h2 style="margin:0; text-align:center; color:var(--k-main-dark)">ğŸ”µ å•µå•µå¬å†™ 11.0</h2>
                    <div class="mode-switcher">
                        <button class="mode-btn active" onclick="setMode('en_basic')">ğŸ…°ï¸ è‹±æ–‡</button>
                        <button class="mode-btn" onclick="setMode('en_trans')">ğŸ§  ä¸­è¯‘è‹±</button>
                        <button class="mode-btn" onclick="setMode('cn_basic')">ğŸ‡¨ğŸ‡³ è¯­æ–‡</button>
                    </div>
                    
                    <div class="tool-row">
                        <span>â±ï¸ æ—¶é—´: <b id="time-val">10</b>s</span>
                        <input type="range" id="time-input" min="1" max="60" value="10" step="1" style="accent-color:var(--k-main)">
                    </div>

                    <div class="ai-toggle-row">
                        <span>ğŸ¤– AI é­”æ³•çœ¼ (æŠ¬å¤´äº¤å·)</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="ai-toggle" onchange="toggleAI()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="tool-row" style="background:#FFF9C4;">
                        <select id="ocr-lang" style="background:transparent; border:none; font-weight:bold;">
                            <option value="eng">è¯†åˆ«è‹±æ–‡</option>
                            <option value="chi_sim">è¯†åˆ«ä¸­æ–‡</option>
                        </select>
                        <input type="file" id="file-input" accept="image/*" hidden onchange="handleScan(this)">
                        <button class="btn btn-scan" onclick="document.getElementById('file-input').click()">ğŸ“· æ‰«æå›¾ç‰‡</button>
                    </div>

                    <textarea id="main-input" placeholder="è¾“å…¥å•è¯ï¼Œä¸€è¡Œä¸€ä¸ª..."></textarea>
                    
                    <div class="btn-group-grid">
                        <button class="btn btn-trans" id="btn-trans" onclick="handleTranslate()">âœ¨ ç¿»è¯‘</button>
                        <button class="btn btn-primary" onclick="initGame()">ğŸš€ å¼€å§‹</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯2: æ¸¸æˆ -->
        <div id="scene-play" class="scene">
            <div class="play-container" id="play-container">
                <button class="btn" style="position:absolute; top:20px; left:20px; background:#ECEFF1; font-size:0.9rem; padding:8px 15px; z-index:10;" onclick="goHome()">ğŸ  é€€å‡º</button>
                <h3 id="progress-txt" style="color:#90A4AE; text-align:center;">1 / 10</h3>
                <div class="timer-bar-wrap"><div id="timer-bar" class="timer-fill"></div></div>
                <div class="answer-box"><span id="ans-txt" style="filter:blur(20px); opacity:0;">Answer</span></div>
                
                <div id="play-controls" style="margin-top:auto;">
                    <div id="status-wait">
                        <button class="btn" style="background:#E1F5FE; margin:0 auto;" onclick="speakCurrent()">ğŸ”Š é‡è¯»</button>
                        <p style="text-align:center; color:#999; margin-top:10px; font-size:0.9rem;" id="ai-hint-write"></p>
                    </div>
                    <div id="status-check" style="display:none; gap:20px; justify-content:center; flex-direction: column; align-items: center;">
                        <div style="display:flex; gap:20px;">
                            <button class="btn" style="background:var(--k-error); color:white;" onclick="nextRound(false)">âŒ é”™äº†</button>
                            <button class="btn" style="background:var(--k-success); color:white;" onclick="nextRound(true)">âœ… å¯¹äº†</button>
                        </div>
                        <p style="text-align:center; color:#999; font-size:0.9rem;" id="ai-hint-check"></p>
                    </div>
                </div>

                <div id="result-overlay" class="result-overlay">
                    <div id="score-badge" class="score-badge">
                        <span style="color:white; font-size:0.8rem; font-weight:bold;">SCORE</span>
                        <span id="score-val">100</span>
                    </div>
                    <div id="fan-correct" class="fan-card correct"><h4>âœ… ç­”å¯¹äº†</h4><div class="list-wrap" id="list-correct"></div></div>
                    <div id="fan-wrong" class="fan-card wrong"><h4>ğŸ’ª éœ€ç»ƒä¹ </h4><div class="list-wrap" id="list-wrong"></div></div>
                    <div class="result-actions">
                        <button class="btn" style="background:#AB47BC; color:white; border:2px solid white;" onclick="exportWrongWords()">ğŸ“¥ å­˜é”™é¢˜</button>
                        <button class="btn btn-primary" style="width:auto; border:2px solid white;" onclick="goHome()">ğŸ”„ å†æ¥ä¸€å±€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- å¼•å…¥ MediaPipe -->
<script type="module">
    import { FilesetResolver, FaceLandmarker, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";
    window.AI_MODULE = { FilesetResolver, FaceLandmarker, HandLandmarker };
    window.dispatchEvent(new Event('ai_ready'));
</script>

<script>
    // --- åŸºç¡€æ•°æ® ---
    const DEFAULT_PRESETS = { "ğŸ ç¤ºä¾‹": "Apple | è‹¹æœ\nBanana | é¦™è•‰" };
    let savedLists = {}; let mode = 'en_basic'; let words = []; let curIdx = 0; let results = [];
    let timerSet = 10; let timerInt = null;

    // --- AI çŠ¶æ€ ---
    let aiEnabled = false;
    let faceLandmarker = null; let handLandmarker = null; let webcamRunning = false;
    let lastVideoTime = -1; let currentPhase = 'none'; // 'writing', 'checking'
    let lookUpFrames = 0; let gestureFrames = 0; let lastGesture = null;

    window.onload = () => { loadPresets(); };

    // --- MediaPipe Init ---
    async function initAIModels() {
        if(!window.AI_MODULE) await new Promise(r => window.addEventListener('ai_ready', r));
        const { FilesetResolver, FaceLandmarker, HandLandmarker } = window.AI_MODULE;
        toggleMask(true, "ä¸‹è½½AIæ¨¡å‹(é¦–æ¬¡è¾ƒæ…¢)...");
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        faceLandmarker = await FaceLandmarker.createFromOptions(vision, { baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" }, outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1 });
        handLandmarker = await HandLandmarker.createFromOptions(vision, { baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task", delegate: "GPU" }, runningMode: "VIDEO", numHands: 1 });
        toggleMask(false);
    }

    async function toggleAI() {
        const toggle = document.getElementById('ai-toggle');
        const widget = document.getElementById('magic-widget');
        if(toggle.checked) {
            if(!faceLandmarker || !handLandmarker) await initAIModels();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 320, height: 240 } });
                const video = document.getElementById('webcam');
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
                webcamRunning = true; aiEnabled = true;
                widget.classList.add('active');
                document.getElementById('ai-hint-write').innerText = "ğŸ¤– AI: ä½å¤´è™šçº¿æ…¢è½¬ï¼ŒæŠ¬å¤´å®çº¿å¿«è½¬è§£é”";
                document.getElementById('ai-hint-check').innerText = "ğŸ¤– AI: å¼ æ‰‹(ğŸ–ï¸)å¯¹ï¼Œæ¡æ‹³(âœŠ)é”™";
            } catch(e) { alert("æ‘„åƒå¤´æ‰“å¼€å¤±è´¥"); toggle.checked = false; }
        } else {
            webcamRunning = false; aiEnabled = false;
            const video = document.getElementById('webcam');
            if(video.srcObject) { video.srcObject.getTracks().forEach(t => t.stop()); video.srcObject = null; }
            widget.classList.remove('active');
            document.getElementById('ai-hint-write').innerText = ""; document.getElementById('ai-hint-check').innerText = "";
        }
    }

    // --- AI Loop ---
    async function predictWebcam() {
        if(!webcamRunning) return;
        const video = document.getElementById('webcam');
        const widget = document.getElementById('magic-widget');
        let startTimeMs = performance.now();

        if (lastVideoTime !== video.currentTime) {
            lastVideoTime = video.currentTime;
            
            // 1. å†™å­—é˜¶æ®µï¼šæ£€æµ‹äººè„¸
            if (currentPhase === 'writing' && faceLandmarker) {
                const result = faceLandmarker.detectForVideo(video, startTimeMs);
                if (result.faceLandmarks.length > 0) {
                    // æ£€æµ‹åˆ°äººè„¸ = æŠ¬å¤´çœ‹å± = ç»¿è‰²å®çº¿å¿«è½¬
                    widget.classList.add('status-looking');
                    widget.classList.remove('status-writing');
                    lookUpFrames++;
                    if(lookUpFrames > 45) { // ~1.5s
                        showMagicFeedback("ğŸ”“");
                        timeUp(); lookUpFrames = 0;
                    }
                } else {
                    // æ²¡æ£€æµ‹åˆ° = ä½å¤´å†™å­— = è“è‰²è™šçº¿æ…¢è½¬
                    widget.classList.add('status-writing');
                    widget.classList.remove('status-looking');
                    lookUpFrames = 0;
                }
                widget.classList.remove('status-checking');
            }

            // 2. æ£€æŸ¥é˜¶æ®µï¼šæ£€æµ‹æ‰‹åŠ¿
            if (currentPhase === 'checking' && handLandmarker) {
                widget.classList.remove('status-writing');
                widget.classList.remove('status-looking');
                widget.classList.add('status-checking'); // ç´«è‰²å‘¼å¸

                const result = handLandmarker.detectForVideo(video, startTimeMs);
                if (result.landmarks.length > 0) {
                    const lm = result.landmarks[0];
                    const wrist = lm[0];
                    const tips = [lm[8], lm[12], lm[16], lm[20]];
                    let avgDist = 0; tips.forEach(p => avgDist += Math.sqrt(Math.pow(p.x-wrist.x, 2) + Math.pow(p.y-wrist.y, 2)));
                    avgDist /= 4;
                    const isFist = avgDist < 0.25; 
                    const currentG = isFist ? 'fist' : 'palm';

                    if(currentG === lastGesture) gestureFrames++;
                    else { gestureFrames = 0; lastGesture = currentG; }

                    if(gestureFrames > 15) {
                        if(isFist) { showMagicFeedback("âŒ"); nextRound(false); }
                        else { showMagicFeedback("âœ…"); nextRound(true); }
                        gestureFrames = 0;
                    }
                }
            }
        }
        window.requestAnimationFrame(predictWebcam);
    }

    function showMagicFeedback(emoji) {
        const ov = document.getElementById('magic-overlay');
        ov.innerText = emoji; ov.classList.add('show');
        setTimeout(() => ov.classList.remove('show'), 1000);
    }

    // --- ä¹¦æ¶ & è¾“å…¥ ---
    function loadPresets() {
        const data = localStorage.getItem('bobo_v8_presets');
        savedLists = data ? JSON.parse(data) : { ...DEFAULT_PRESETS };
        renderMenu();
    }
    function savePresets() { localStorage.setItem('bobo_v8_presets', JSON.stringify(savedLists)); }
    function renderMenu() {
        const container = document.getElementById('menu-area'); container.innerHTML = '';
        const keys = Object.keys(savedLists); document.getElementById('book-count').innerText = keys.length;
        keys.forEach((key, i) => {
            const btn = document.createElement('div'); btn.className = 'k-btn-menu';
            const offset = Math.sin(i*0.8)*15+10; const rot = Math.cos(i*0.8)*3;
            btn.style.transform = `translateX(${offset}px) rotate(${rot}deg)`;
            btn.onclick = () => { loadList(key); highlightBtn(btn); };
            btn.innerHTML = `<span class="k-btn-text">${key}</span><div class="k-btn-del" onclick="event.stopPropagation();deleteList('${key}')">âœ–</div>`;
            container.appendChild(btn);
        });
    }
    function highlightBtn(t) { document.querySelectorAll('.k-btn-menu').forEach(b=>b.classList.remove('active')); if(t)t.classList.add('active'); }
    function saveCurrentToList() {
        if(Object.keys(savedLists).length>=7) return alert("ğŸ“š ä¹¦æ¶æ»¡å•¦ (7/7)");
        const txt = document.getElementById('main-input').value.trim(); if(!txt)return alert("ç©ºå†…å®¹");
        const n = prompt("åç§°:", "New List"); if(n){ savedLists[n]=txt; savePresets(); renderMenu(); }
    }
    function deleteList(k){ if(confirm(`Del "${k}"?`)){ delete savedLists[k]; savePresets(); renderMenu(); } }
    function loadList(k){ document.getElementById('main-input').value=savedLists[k]; updatePreview(); playPop(); }
    
    document.getElementById('main-input').addEventListener('input', updatePreview);
    document.getElementById('time-input').addEventListener('input', (e)=>{ timerSet=parseInt(e.target.value); document.getElementById('time-val').innerText=timerSet; });

    function parseContent(t) {
        return t.split('\n').map(l=>{
            const trim=l.trim(); if(!trim)return null;
            if(trim.includes('|')){ 
                const p=trim.split('|'); const p1=p[0].trim(); const p2=p[1].trim();
                return /[\u4e00-\u9fa5]/.test(p1) ? {src:p1, tgt:p2} : {src:p2, tgt:p1};
            }
            return {src:trim, tgt:trim};
        }).filter(x=>x);
    }
    function updatePreview(){
        const txt = document.getElementById('main-input').value; const p = parseContent(txt);
        document.getElementById('count').innerText = p.length;
        document.getElementById('preview-list').innerHTML = p.map(i=> {
            const nt = (mode==='en_trans'&&i.src===i.tgt&&/[\u4e00-\u9fa5]/.test(i.src));
            return `<div class="preview-item"><div><b>${i.tgt}</b> <small>(${i.src})</small></div>${nt?'<span class="tag-trans">å¾…è¯‘</span>':''}</div>`;
        }).join('');
    }
    function setMode(m){ mode=m; document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); 
    document.getElementById('btn-trans').style.display = (mode==='en_trans')?'flex':'none'; updatePreview(); }

    async function handleTranslate(){
        const raw=document.getElementById('main-input').value; const p=parseContent(raw); if(!p.length)return;
        toggleMask(true,"ç¿»è¯‘ä¸­..."); let n=[];
        for(let i of p){
            if(i.src===i.tgt && /[\u4e00-\u9fa5]/.test(i.src)){
                try{ const en = await fetchTrans(i.src); n.push(`${en} | ${i.src}`); } catch(e){ n.push(`${i.src}|${i.src}`); }
            } else { if(i.src!==i.tgt)n.push(`${i.tgt} | ${i.src}`); else n.push(i.src); }
        }
        document.getElementById('main-input').value=n.join('\n'); toggleMask(false); updatePreview();
    }
    async function fetchTrans(q){ const r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(q)}&langpair=zh|en`); const d=await r.json(); return d.responseData.translatedText.replace(/[.ã€‚!ï¼]$/, ''); }

    // --- Game Logic ---
    function initGame(){
        const txt=document.getElementById('main-input').value; const p=parseContent(txt);
        if(!p.length)return alert("æ— å†…å®¹");
        if(mode==='en_trans' && p.some(i=>i.src===i.tgt&&/[\u4e00-\u9fa5]/.test(i.src))) if(!confirm("æœ‰æœªç¿»è¯‘å†…å®¹ï¼Œç»§ç»­?"))return;
        words=p; startGame();
    }

    function startGame(){
        curIdx=0; results=[];
        document.getElementById('play-container').classList.remove('dimmed');
        document.getElementById('result-overlay').classList.remove('active');
        document.getElementById('fan-correct').classList.remove('active');
        document.getElementById('fan-wrong').classList.remove('active');
        document.getElementById('score-badge').classList.remove('active');
        showScene('scene-play');
        playRound();
    }

    function playRound(){
        if(curIdx>=words.length) return showResult();
        const cur=words[curIdx];
        
        // Reset AI state
        currentPhase = 'writing';
        const w = document.getElementById('magic-widget');
        w.classList.remove('status-checking'); w.classList.remove('status-looking'); w.classList.add('status-writing');

        document.getElementById('progress-txt').innerText=`${curIdx+1}/${words.length}`;
        const ans=document.getElementById('ans-txt'); ans.innerText=cur.tgt; ans.style.filter='blur(20px)'; ans.style.opacity='0';
        document.getElementById('status-wait').style.display='block';
        document.getElementById('status-check').style.display='none';
        
        const bar=document.getElementById('timer-bar'); bar.style.transition='none'; bar.style.width='100%';
        speakCurrent();
        setTimeout(()=>{ bar.style.transition=`width ${timerSet}s linear`; bar.style.width='0%'; },100);
        clearTimeout(timerInt); timerInt=setTimeout(timeUp, timerSet*1000);
    }

    function speakCurrent(){
        const cur=words[curIdx]; const t=(mode==='en_trans')?cur.src:cur.tgt;
        const u=new SpeechSynthesisUtterance(t); u.lang=/[\u4e00-\u9fa5]/.test(t)?'zh-CN':'en-US';
        window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
    }

    function timeUp(){
        playDing();
        clearTimeout(timerInt);
        currentPhase = 'checking'; // AI Phase: Check
        
        const ans=document.getElementById('ans-txt'); ans.style.filter='blur(0)'; ans.style.opacity='1';
        document.getElementById('status-wait').style.display='none';
        document.getElementById('status-check').style.display='flex';
    }

    function nextRound(ok){
        playPop();
        currentPhase = 'none'; // Pause AI
        results.push({...words[curIdx], ok}); curIdx++; 
        setTimeout(playRound, 1000); // Delay for transition
    }

    function showResult(){
        currentPhase = 'none';
        document.getElementById('play-container').classList.add('dimmed');
        document.getElementById('result-overlay').classList.add('active');
        const c=results.filter(r=>r.ok); const w=results.filter(r=>!r.ok);
        document.getElementById('score-val').innerText=c.length;
        const r=(l,id)=>document.getElementById(id).innerHTML=l.map(i=>`<div style="border-bottom:1px solid #EEE;padding:4px;"><b>${i.tgt}</b> <small>(${i.src})</small></div>`).join('');
        r(c,'list-correct'); r(w,'list-wrong');
        setTimeout(()=>{
            document.getElementById('fan-correct').classList.add('active');
            document.getElementById('fan-wrong').classList.add('active');
            document.getElementById('score-badge').classList.add('active');
            playPop();
        },100);
    }

    // --- Misc ---
    function handleScan(i){ 
        if(!i.files[0])return; toggleMask(true,"è¯†åˆ«ä¸­..."); 
        Tesseract.recognize(i.files[0],document.getElementById('ocr-lang').value).then(({data:{text}})=>{
            const c=text.split('\n').map(s=>s.trim()).filter(s=>s.length>1).join('\n');
            const a=document.getElementById('main-input'); a.value=(a.value+'\n'+c).trim();
            updatePreview(); toggleMask(false);
        }).catch(()=>{ alert("å¤±è´¥"); toggleMask(false); });
    }
    function exportWrongWords(){
        const w=results.filter(r=>!r.ok); if(!w.length)return alert("æ— é”™é¢˜");
        const t=w.map(r=>`${r.tgt} | ${r.src}`).join('\n');
        const b=new Blob([t],{type:"text/plain"}); const a=document.createElement('a');
        a.href=URL.createObjectURL(b); a.download=`é”™é¢˜_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function goHome(){ document.getElementById('play-container').classList.remove('dimmed'); showScene('scene-setup'); currentPhase='none'; }
    function showScene(id){ document.querySelectorAll('.scene').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function toggleMask(s,t){ document.getElementById('mask').style.display=s?'flex':'none'; if(t)document.getElementById('mask-txt').innerText=t; }
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    function playPop(){ if(ctx.state==='suspended')ctx.resume(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.setValueAtTime(400,ctx.currentTime); o.frequency.exponentialRampToValueAtTime(600,ctx.currentTime+0.1); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.1); o.start(); o.stop(ctx.currentTime+0.1); }
    function playDing(){ if(ctx.state==='suspended')ctx.resume(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.setValueAtTime(800,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+0.5); o.start(); o.stop(ctx.currentTime+0.5); }
    
    setMode('en_basic');
</script>
<style>@keyframes spin { to { transform: rotate(360deg); } }</style>
</body>
</html>